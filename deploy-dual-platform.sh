#!/bin/bash

# åŒå¹³å°åŒæ­¥éƒ¨ç½²è„šæœ¬
# è‡ªåŠ¨éƒ¨ç½²åˆ° Vercel + Gitee Pages

set -e

PROJECT_DIR="/data1/cc/vide-coding/ai-news-hub"
cd "$PROJECT_DIR"

echo "=========================================="
echo "  åŒå¹³å°åŒæ­¥éƒ¨ç½²å¼€å§‹"
echo "=========================================="
echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 1. æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
echo -e "${BLUE}[1/6] æ£€æŸ¥ Git çŠ¶æ€...${NC}"
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}âš ï¸  æœ‰æœªæäº¤çš„æ›´æ”¹ï¼Œè¯·å…ˆæäº¤${NC}"
    git status --short
    exit 1
fi
echo -e "${GREEN}âœ“ Git å·¥ä½œåŒºå¹²å‡€${NC}"
echo ""

# 2. æ‹‰å–æœ€æ–°ä»£ç 
echo -e "${BLUE}[2/6] æ‹‰å–æœ€æ–°ä»£ç ...${NC}"
git fetch --all
git pull origin main
echo -e "${GREEN}âœ“ ä»£ç å·²æ›´æ–°${NC}"
echo ""

# 3. å®‰è£…ä¾èµ–
echo -e "${BLUE}[3/6] å®‰è£…é¡¹ç›®ä¾èµ–...${NC}"
npm install
echo -e "${GREEN}âœ“ ä¾èµ–å®‰è£…å®Œæˆ${NC}"
echo ""

# 4. æ„å»ºé¡¹ç›®
echo -e "${BLUE}[4/6] æ„å»º VitePress ç½‘ç«™...${NC}"
npm run docs:build

if [ ! -d "docs/.vitepress/dist" ]; then
    echo -e "${RED}âŒ æ„å»ºå¤±è´¥ï¼šdist ç›®å½•ä¸å­˜åœ¨${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ ç½‘ç«™æ„å»ºå®Œæˆ${NC}"
echo ""

# 5. æäº¤æ„å»ºäº§ç‰©
echo -e "${BLUE}[5/6] æäº¤æ„å»ºäº§ç‰©åˆ° Git...${NC}"
git add docs/.vitepress/dist/

# æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ„å»ºäº§ç‰©
if git diff --cached --quiet; then
    echo -e "${YELLOW}âš ï¸  æ²¡æœ‰æ–°çš„æ„å»ºäº§ç‰©ï¼Œè·³è¿‡æäº¤${NC}"
else
    git commit -m "Build: Auto-deploy - $(date '+%Y-%m-%d %H:%M:%S')

- VitePress build completed
- Sync to dual platform (Vercel + Gitee)
- Auto-generated by deploy-dual-platform.sh"

    echo -e "${GREEN}âœ“ æ„å»ºäº§ç‰©å·²æäº¤${NC}"
fi
echo ""

# 6. æ¨é€åˆ°åŒå¹³å°
echo -e "${BLUE}[6/6] æ¨é€åˆ°åŒå¹³å°...${NC}"
echo ""

# æ¨é€åˆ° GitHub (Vercel)
echo -e "${YELLOW}â†’ æ¨é€åˆ° GitHub (Vercel è‡ªåŠ¨è§¦å‘)...${NC}"
git push origin main
if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ“ GitHub æ¨é€æˆåŠŸ${NC}"
    echo -e "   ${GREEN}â†’ Vercel éƒ¨ç½²åœ°å€: https://ai-news-hub-rosy.vercel.app/${NC}"
else
    echo -e "${RED}âœ— GitHub æ¨é€å¤±è´¥${NC}"
fi
echo ""

# æ¨é€åˆ° Gitee (Gitee Pages)
echo -e "${YELLOW}â†’ æ¨é€åˆ° Gitee (Gitee Pages è‡ªåŠ¨è§¦å‘)...${NC}"
git push gitee main
if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ“ Gitee æ¨é€æˆåŠŸ${NC}"
    echo -e "   ${GREEN}â†’ Gitee Pages åœ°å€: https://zhao-nancheng.gitee.io/ai-news-hub/${NC}"
else
    echo -e "${RED}âœ— Gitee æ¨é€å¤±è´¥${NC}"
    echo -e "${YELLOW}âš ï¸  è¯·ç¡®ä¿å·²æ·»åŠ  Gitee è¿œç¨‹ä»“åº“${NC}"
    echo -e "${YELLOW}âš ï¸  è¿è¡Œ: git remote add gitee <ä½ çš„giteeä»“åº“åœ°å€>${NC}"
fi
echo ""

# 7. æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
echo "=========================================="
echo "  éƒ¨ç½²å®Œæˆ"
echo "=========================================="
echo ""
echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€:"
echo ""
echo "ğŸŒ å›½é™…è®¿é—®:"
echo "   https://ai-news-hub-rosy.vercel.app/"
echo ""
echo "ğŸ‡¨ğŸ‡³ å›½å†…è®¿é—®:"
echo "   https://zhao-nancheng.gitee.io/ai-news-hub/"
echo ""
echo "ğŸ“ æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—:"
echo "   Vercel: https://vercel.com/zhao-nancheng-s-projects"
echo "   Gitee: https://gitee.com/zhao-nancheng/ai-news-hub/pages"
echo ""
echo "âœ… åŒå¹³å°åŒæ­¥éƒ¨ç½²å®Œæˆï¼"
echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""
