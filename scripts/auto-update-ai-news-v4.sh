#!/bin/bash

# AI News è‡ªåŠ¨æ›´æ–°è„šæœ¬ v4.0
# æ•´åˆï¼šæ–°é—»æŠ“å– + è®ºæ–‡æ¨è + çƒ­ç‚¹æ€»ç»“ + å†å²å½’æ¡£

set -e

# é…ç½®
PROJECT_DIR="/data1/cc/vide-coding/ai-news-hub"
NEWS_DIR="$PROJECT_DIR/docs/news"
PAPERS_DIR="$PROJECT_DIR/docs/papers"
WEEKLY_DIR="$PROJECT_DIR/docs/weekly"
DATE=$(date +"%Y-%m-%d")
DATETIME=$(date +"%Y-%m-%d %H:%M:%S")
TIMESTAMP=$(date +%s)

export PROJECT_DIR NEWS_DIR PAPERS_DIR DATE DATETIME

echo "=========================================="
echo "  AI News è‡ªåŠ¨æ›´æ–°å¼€å§‹ (v4.0 æ•´åˆç‰ˆ)"
echo "=========================================="
echo "æ—¶é—´: $DATETIME"
echo ""

# åˆ›å»ºç›®å½•
mkdir -p "$NEWS_DIR"
mkdir -p "$PAPERS_DIR"
mkdir -p "$WEEKLY_DIR"

echo "ğŸ“° Step 1: å¢å¼ºç‰ˆå¤šæºæŠ“å–ï¼ˆEnhancedï¼‰..."
python3.9 /data1/cc/vide-coding/ai-news-hub/scripts/fetch-enhanced.py

echo ""
echo "ğŸ“š Step 2: æŠ“å– arXiv AI è®ºæ–‡..."
python3.9 /data1/cc/vide-coding/ai-news-hub/scripts/fetch-arxiv-papers.py

echo ""
echo "ğŸ“Š Step 3: æ›´æ–°é¦–é¡µç´¢å¼•..."
python3.9 /data1/cc/vide-coding/ai-news-hub/scripts/update-homepage.py

echo ""
echo "ğŸ”„ Step 4: æ¨é€åˆ° GitHub + GitLab..."
cd "$PROJECT_DIR"

# æ·»åŠ æ‰€æœ‰æ›´æ”¹
git add docs/news/ docs/papers/ docs/latest-news.md

# è·å–æ–‡ä»¶è¡Œæ•°
NEWS_LINES=$(wc -l < "$NEWS_DIR/$DATE.md" 2>/dev/null || echo "0")
PAPERS_LINES=$(wc -l < "$PAPERS_DIR/$DATE.md" 2>/dev/null || echo "0")

# æäº¤æ›´æ”¹
COMMIT_MSG="Auto-update: AI News briefing - $DATE

- News: $NEWS_LINES lines
- Papers: $PAPERS_LINES lines
- Homepage: Updated
- Timestamp: $TIMESTAMP
- Auto-generated by ai-news-hub v4.0"

git commit -m "$COMMIT_MSG"

# æ¨é€åˆ° GitHub
echo "æ¨é€åˆ° GitHub..."
git push origin master

echo ""
echo "æ¨é€åˆ° GitLab..."
git push gitlab master || echo "âš ï¸  GitLab æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰"

echo ""
echo "âœ… æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼"
echo "Vercel å°†è‡ªåŠ¨æ£€æµ‹å¹¶é‡æ–°éƒ¨ç½²..."

echo ""
echo "=========================================="
echo "  è‡ªåŠ¨æ›´æ–°å®Œæˆï¼"
echo "=========================================="
echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""
